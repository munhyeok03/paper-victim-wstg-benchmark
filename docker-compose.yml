# ===========================================
# AI Agent Attack Automation
# ===========================================
# Each agent has its own isolated network with dedicated victim container
# Networks are completely separated - no cross-agent communication possible

networks:
  # Isolated network for Codex agent
  net-codex:
    driver: bridge
  # Isolated network for Claude agent
  net-claude:
    driver: bridge
  # Isolated network for Gemini agent
  net-gemini:
    driver: bridge

services:
  # ===========================================
  # METRICS PROXY (LiteLLM)
  # ===========================================
  # Central proxy for token/call tracking across all agents
  metrics-proxy:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: metrics-proxy
    command: ["--config", "/app/config.yaml", "--detailed_debug"]
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - LITELLM_LOG=DEBUG
      - METRICS_LOG_DIR=/app/logs
      - PYTHONPATH=/app
      # Execution limits (0 = unlimited)
      - AGENT_TOKEN_LIMIT=${AGENT_TOKEN_LIMIT:-0}
      - AGENT_CALL_LIMIT=${AGENT_CALL_LIMIT:-0}
      - AGENT_COST_LIMIT=${AGENT_COST_LIMIT:-0}
    volumes:
      - ./metrics/litellm_config.yaml:/app/config.yaml:ro
      - ./metrics/custom_logger.py:/app/custom_logger.py:ro
      - ./metrics/logs:/app/logs
    networks:
      - net-claude
      - net-codex
      - net-gemini
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/health/liveliness')"]
      interval: 5s
      timeout: 5s
      retries: 10
    ports:
      - "4000:4000"  # Debug access (optional)

  # ===========================================
  # VICTIM-SIDE MONITORS (Impact Detection)
  # ===========================================
  monitor-codex:
    build:
      context: ./metrics
      dockerfile: Dockerfile.monitor
    container_name: monitor-codex
    pid: "service:victim-codex"
    environment:
      - AGENT_NAME=codex
      - LOG_DIR=/logs
      - APP_ROOT=${VICTIM_APP_ROOT:-/app}
      - POLL_INTERVAL=0.25
      - STARTUP_GRACE_PERIOD=30
    volumes:
      - ./results/${SESSION_TIMESTAMP}/monitors:/logs
    networks:
      - net-codex
    depends_on:
      - victim-codex
    cap_add:
      - SYS_PTRACE

  monitor-claude:
    build:
      context: ./metrics
      dockerfile: Dockerfile.monitor
    container_name: monitor-claude
    pid: "service:victim-claude"
    environment:
      - AGENT_NAME=claude
      - LOG_DIR=/logs
      - APP_ROOT=${VICTIM_APP_ROOT:-/app}
      - POLL_INTERVAL=0.25
      - STARTUP_GRACE_PERIOD=30
    volumes:
      - ./results/${SESSION_TIMESTAMP}/monitors:/logs
    networks:
      - net-claude
    depends_on:
      - victim-claude
    cap_add:
      - SYS_PTRACE

  monitor-gemini:
    build:
      context: ./metrics
      dockerfile: Dockerfile.monitor
    container_name: monitor-gemini
    pid: "service:victim-gemini"
    environment:
      - AGENT_NAME=gemini
      - LOG_DIR=/logs
      - APP_ROOT=${VICTIM_APP_ROOT:-/app}
      - POLL_INTERVAL=0.25
      - STARTUP_GRACE_PERIOD=30
    volumes:
      - ./results/${SESSION_TIMESTAMP}/monitors:/logs
    networks:
      - net-gemini
    depends_on:
      - victim-gemini
    cap_add:
      - SYS_PTRACE

  # ===========================================
  # CODEX ENVIRONMENT (Isolated)
  # ===========================================
  victim-codex:
    image: ${VICTIM_IMAGE:-bkimminich/juice-shop}
    container_name: victim-codex
    networks:
      - net-codex
    ports:
      - "3002:${VICTIM_PORT:-3000}"  # Host access for challenge verification

  http-logger-codex:
    image: mitmproxy/mitmproxy:latest
    container_name: http-logger-codex
    command: mitmdump --mode reverse:http://victim-codex:${VICTIM_PORT:-3000} -p 8080 -s /scripts/http_logger.py --set block_global=false
    environment:
      - AGENT_NAME=codex
      - LOG_DIR=/logs
    volumes:
      - ./metrics/http_logger.py:/scripts/http_logger.py:ro
      - ./results/${SESSION_TIMESTAMP}/http-logs:/logs
    networks:
      - net-codex
    depends_on:
      - victim-codex

  agent-codex:
    build:
      context: ./agents
      dockerfile: codex/Dockerfile
    image: agent-codex:latest
    container_name: agent-codex
    networks:
      - net-codex
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=http://metrics-proxy:4000
      - AGENT_TYPE=codex
      - CODEX_MODEL=${CODEX_MODEL:-gpt-5.2-codex}
      - OUTPUT_MODE=${OUTPUT_MODE:-report}
      - OUTPUT_FORMAT_FILE=${OUTPUT_FORMAT_FILE:-}
      - SESSION_TIMESTAMP=${SESSION_TIMESTAMP}
      - VICTIM_HOST=http-logger-codex
      - VICTIM_PORT=8080
    volumes:
      - ./prompts:/prompts:ro
      - ./output_formats:/output_formats:ro
    depends_on:
      http-logger-codex:
        condition: service_started
      metrics-proxy:
        condition: service_healthy

  # ===========================================
  # CLAUDE ENVIRONMENT (Isolated)
  # ===========================================
  victim-claude:
    image: ${VICTIM_IMAGE:-bkimminich/juice-shop}
    container_name: victim-claude
    networks:
      - net-claude
    ports:
      - "3001:${VICTIM_PORT:-3000}"  # Host access for challenge verification

  http-logger-claude:
    image: mitmproxy/mitmproxy:latest
    container_name: http-logger-claude
    command: mitmdump --mode reverse:http://victim-claude:${VICTIM_PORT:-3000} -p 8080 -s /scripts/http_logger.py --set block_global=false
    environment:
      - AGENT_NAME=claude
      - LOG_DIR=/logs
    volumes:
      - ./metrics/http_logger.py:/scripts/http_logger.py:ro
      - ./results/${SESSION_TIMESTAMP}/http-logs:/logs
    networks:
      - net-claude
    depends_on:
      - victim-claude

  agent-claude:
    build:
      context: ./agents
      dockerfile: claude/Dockerfile
    image: agent-claude:latest
    container_name: agent-claude
    networks:
      - net-claude
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=http://metrics-proxy:4000
      - AGENT_TYPE=claude
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-opus-4-5-20251101}
      - OUTPUT_MODE=${OUTPUT_MODE:-report}
      - OUTPUT_FORMAT_FILE=${OUTPUT_FORMAT_FILE:-}
      - SESSION_TIMESTAMP=${SESSION_TIMESTAMP}
      - VICTIM_HOST=http-logger-claude
      - VICTIM_PORT=8080
    volumes:
      - ./prompts:/prompts:ro
      - ./output_formats:/output_formats:ro
    depends_on:
      http-logger-claude:
        condition: service_started
      metrics-proxy:
        condition: service_healthy

  # ===========================================
  # GEMINI ENVIRONMENT (Isolated)
  # ===========================================
  victim-gemini:
    image: ${VICTIM_IMAGE:-bkimminich/juice-shop}
    container_name: victim-gemini
    networks:
      - net-gemini
    ports:
      - "3003:${VICTIM_PORT:-3000}"  # Host access for challenge verification

  http-logger-gemini:
    image: mitmproxy/mitmproxy:latest
    container_name: http-logger-gemini
    command: mitmdump --mode reverse:http://victim-gemini:${VICTIM_PORT:-3000} -p 8080 -s /scripts/http_logger.py --set block_global=false
    environment:
      - AGENT_NAME=gemini
      - LOG_DIR=/logs
    volumes:
      - ./metrics/http_logger.py:/scripts/http_logger.py:ro
      - ./results/${SESSION_TIMESTAMP}/http-logs:/logs
    networks:
      - net-gemini
    depends_on:
      - victim-gemini

  agent-gemini:
    build:
      context: ./agents
      dockerfile: gemini/Dockerfile
    image: agent-gemini:latest
    container_name: agent-gemini
    networks:
      - net-gemini
    environment:
      - GEMINI_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_GEMINI_BASE_URL=http://metrics-proxy:4000
      - AGENT_TYPE=gemini
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-3-pro-preview}
      - OUTPUT_MODE=${OUTPUT_MODE:-report}
      - OUTPUT_FORMAT_FILE=${OUTPUT_FORMAT_FILE:-}
      - SESSION_TIMESTAMP=${SESSION_TIMESTAMP}
      - VICTIM_HOST=http-logger-gemini
      - VICTIM_PORT=8080
    volumes:
      - ./prompts:/prompts:ro
      - ./output_formats:/output_formats:ro
    depends_on:
      http-logger-gemini:
        condition: service_started
      metrics-proxy:
        condition: service_healthy

  # ===========================================
  # BASE IMAGE BUILD (utility)
  # ===========================================
  agent-base:
    build:
      context: ./agents
      dockerfile: base/Dockerfile
    image: agent-base:latest
    container_name: agent-base-build
    command: ["echo", "Base image built successfully"]
