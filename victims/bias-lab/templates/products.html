{% extends "base.html" %}
{% block title %}Market | Bias Market{% endblock %}
{% block content %}
<section class="section">
  <div class="section-header">
    <h2>Market</h2>
    <p>Search by keyword, filter by category, or sort by price.</p>
  </div>
  <form class="search-bar" method="get" action="{{ url_for('products') }}">
    <input type="text" name="q" placeholder="Search products" value="{{ query }}" />
    <select name="category">
      <option value="">All categories</option>
      {% for cat in categories %}
        <option value="{{ cat }}" {% if cat == category %}selected{% endif %}>{{ cat|title }}</option>
      {% endfor %}
    </select>
    <select name="sort">
      <option value="">Sort</option>
      <option value="price ASC" {% if sort == 'price ASC' %}selected{% endif %}>Price low-high</option>
      <option value="price DESC" {% if sort == 'price DESC' %}selected{% endif %}>Price high-low</option>
      <option value="name ASC" {% if sort == 'name ASC' %}selected{% endif %}>Name A-Z</option>
    </select>
    <button class="btn primary" type="submit">Search</button>
  </form>
  <div class="results-meta">
    <span class="pill">{{ products|length }} items</span>
    {% if query %}
      <span class="pill">Search: {{ query }}</span>
    {% endif %}
    {% if category %}
      <span class="pill">Category: {{ category|title }}</span>
    {% endif %}
    {% if sort %}
      <span class="pill">Sort: {{ sort }}</span>
    {% endif %}
  </div>
  {% if error %}
    <div class="alert">Search error: {{ error }}</div>
  {% endif %}
  {% if sql %}
    <pre class="code">{{ sql }}</pre>
  {% endif %}
</section>

<section class="section">
  <div class="grid">
    {% for product in products %}
    <article class="card product-card reveal" style="--delay: {{ loop.index0 * 70 }}ms;">
      <div class="product-media">
        <img src="{{ product['image_url'] }}" alt="{{ product['name'] }}" loading="lazy" />
        <span class="product-tag">{{ product['category'] }}</span>
      </div>
      <div class="product-body">
        <div class="product-brand">{{ product['brand'] }}</div>
        <h3>{{ product['name'] }}</h3>
        <p>{{ product['description'] }}</p>
        <div class="product-meta">
          <span class="price">${{ '%.2f'|format(product['price']) }}</span>
          <span class="rating">â˜… {{ '%.1f'|format(product['rating']) }} ({{ product['review_count'] }})</span>
        </div>
        <div class="product-actions">
          <form method="post" action="{{ url_for('cart_add') }}">
            <input type="hidden" name="product_id" value="{{ product['id'] }}" />
            <input type="hidden" name="qty" value="1" />
            <button class="btn small primary" type="submit">Add to cart</button>
          </form>
          <a class="btn small ghost" href="/product/{{ product['id'] }}">View</a>
        </div>
      </div>
    </article>
    {% endfor %}
  </div>
</section>
{% endblock %}
